<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>HTML CAPTURE | BLACKFLAG</title>

<link rel="manifest" href="manifest.json">

<style>
body { font-family: sans-serif; padding: 10px; }
.preview img { max-width: 100%; border: 1px solid #ccc; }

.gallery {
	display: grid;
	grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
	gap: 8px;
	margin-top: 10px;
}
.gallery img {
	width: 100%;
	border: 1px solid #ccc;
}
.gallery button {
	width: 100%;
	font-size: 12px;
}

.toast {
	position: fixed;
	bottom: 20px;
	left: 50%;
	transform: translateX(-50%);
	background: rgba(0,0,0,0.8);
	color: #fff;
	padding: 8px 16px;
	border-radius: 20px;
	display: none;
}
</style>
</head>

<body>
<h1>HTML CAPTURE</h1>

<!-- 撮影 -->
<h2>撮影</h2>
<input type="file" accept="image/*" capture="environment" id="camera">
<div class="preview"></div>

<!-- 保存済み一覧 -->
<h2>保存済み写真</h2>
<div class="gallery" id="gallery"></div>

<div class="toast" id="toast">保存しました</div>

<script>
// --------------------
// Service Worker
// --------------------
if ('serviceWorker' in navigator) {
	navigator.serviceWorker.register('sw.js');
}

// --------------------
// IndexedDB
// --------------------
let db;
const req = indexedDB.open('capture-db', 1);

req.onupgradeneeded = e => {
	e.target.result.createObjectStore('photos', { autoIncrement: true });
};

req.onsuccess = e => {
	db = e.target.result;
	loadGallery();
};

// --------------------
// 保存
// --------------------
function savePhoto(blob) {
	const tx = db.transaction('photos', 'readwrite');
	tx.objectStore('photos').add(blob);
	tx.oncomplete = loadGallery;
}

// --------------------
// 一覧表示
// --------------------
function loadGallery() {
	const gallery = document.getElementById('gallery');
	gallery.innerHTML = '';

	const tx = db.transaction('photos', 'readonly');
	const store = tx.objectStore('photos');

	store.openCursor().onsuccess = e => {
		const cursor = e.target.result;
		if (!cursor) return;

		const div = document.createElement('div');

		const img = document.createElement('img');
		img.src = URL.createObjectURL(cursor.value);
		div.appendChild(img);

		// 削除ボタン
		const del = document.createElement('button');
		del.textContent = '削除';
		del.onclick = () => {
			const dtx = db.transaction('photos', 'readwrite');
			dtx.objectStore('photos').delete(cursor.key);
			dtx.oncomplete = loadGallery;
		};
		div.appendChild(del);

		gallery.appendChild(div);
		cursor.continue();
	};
}

// --------------------
// 撮影 → 保存
// --------------------
document.getElementById('camera').addEventListener('change', e => {
	const file = e.target.files[0];
	if (!file) return;

	// プレビュー
	const preview = document.querySelector('.preview');
	preview.innerHTML = '';
	const img = document.createElement('img');
	img.src = URL.createObjectURL(file);
	preview.appendChild(img);

	// 自動保存っぽい
	savePhoto(file);
	showToast();
});

// --------------------
// トースト
// --------------------
function showToast() {
	const t = document.getElementById('toast');
	t.style.display = 'block';
	setTimeout(() => t.style.display = 'none', 2000);
}
</script>

</body>
</html>
